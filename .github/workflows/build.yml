name: build-offline

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "1Panel tag/branch (v2.x); empty to use ref name (for tag push)"
        required: false
        default: ""
      arch:
        description: "GOARCH target (e.g. loong64, amd64, arm64)"
        required: false
        default: "loong64"
      go_version:
        description: "Go version used by the builder image"
        required: false
        default: "1.24"
      node_version:
        description: "Node.js version used by the frontend build"
        required: false
        default: "20"
  schedule:
    - cron: "0 2 * * *" # daily

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set build variables
        id: vars
        run: |
          set -e
          VERSION_INPUT="${{ inputs.version }}"
          ARCH_INPUT="${{ inputs.arch }}"
          GO_VER_INPUT="${{ inputs.go_version }}"
          NODE_VER_INPUT="${{ inputs.node_version }}"

          if [ -n "$VERSION_INPUT" ]; then
            VERSION="$VERSION_INPUT"
          elif [ "${GITHUB_REF##refs/tags/}" != "$GITHUB_REF" ]; then
            VERSION="$GITHUB_REF_NAME"
          else
            VERSION=$(curl -s https://api.github.com/repos/1Panel-dev/1Panel/releases/latest | jq -r .tag_name)
          fi

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            VERSION="v2.0.13"
          fi

          ARCH="${ARCH_INPUT:-loong64}"
          GO_VER="${GO_VER_INPUT:-1.24}"
          NODE_VER="${NODE_VER_INPUT:-20}"

          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "ARCH=$ARCH" >> "$GITHUB_ENV"
          echo "GO_VER=$GO_VER" >> "$GITHUB_ENV"
          echo "NODE_VER=$NODE_VER" >> "$GITHUB_ENV"

      - name: Build builder image
        run: |
          docker build \
            -f Dockerfile \
            --build-arg VERSION="${VERSION}" \
            --build-arg TARGET_ARCH="${ARCH}" \
            --build-arg GO_VERSION="${GO_VER}" \
            --build-arg NODE_VERSION="${NODE_VER}" \
            -t "1panel-v2-builder:${{ github.sha }}" \
            .

      - name: Export artifacts
        run: |
          mkdir -p dist
          docker run --rm -v "$PWD/dist:/dist" "1panel-v2-builder:${{ github.sha }}"
          ls -lh dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: 1panel-${{ env.VERSION }}-${{ env.ARCH }}
          path: dist/*
